<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AiDoc.work - æ•°æ®åŒå‘¨æŠ¥å·¥å…·</title>
    <link rel="icon" type="image/png" href="https://www.aidoc.work/favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* å…¨å±€åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        html {
            overflow-y: scroll; /* å§‹ç»ˆæ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ */
            scrollbar-width: thin; /* Firefox */
        }
        
        /* é’ˆå¯¹WebKitæµè§ˆå™¨çš„æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px; /* æ»šåŠ¨æ¡å®½åº¦ */
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1; /* æ»šåŠ¨æ¡è½¨é“èƒŒæ™¯è‰² */
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; /* æ»šåŠ¨æ¡æ»‘å—é¢œè‰² */
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; /* é¼ æ ‡æ‚¬åœæ—¶æ»‘å—é¢œè‰² */
        }

        body {
            background: #f0f2f5;
            color: #4a5568;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .nav-bar {
            background: white;
            padding: 15px 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .nav-brand {
            font-size: 1.2em;
            font-weight: 600;
            color: #1a73e8;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            color: #4a5568;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            height: 36px;
        }

        .nav-link:hover {
            background: #f0f2f5;
            color: #1a73e8;
        }

        .nav-link.active {
            background: #e8f0fe;
            color: #1a73e8;
        }

        .container {
            max-width: 1400px;
            margin: 1rem auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 32px;
            font-weight: 600;
            font-size: 28px;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 32px;
            padding: 28px;
            border: 2px dashed #1a73e8;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(26, 115, 232, 0.1) 0%, rgba(26, 115, 232, 0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-section:hover::before {
            opacity: 1;
        }

        .upload-section:hover {
            border-color: #0d6efd;
            background: linear-gradient(135deg, #e8f0fe 0%, #f8f9ff 100%);
            transform: translateY(-2px);
        }

        #file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #72f2ff 0%, #9b6dff 50%, #ff6b6b 100%);
            background-size: 200% auto;
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            text-shadow: 0 0 8px rgba(255,255,255,0.3);
            box-shadow: 0 0 20px rgba(114, 242, 255, 0.5);
            animation: gradientFlow 15s linear infinite;
        }

        .upload-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .chart-container {
            height: 600px;
            margin-top: 24px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            background-color: #fff;
            padding: 16px;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 100%;
        }

        .chart-container:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .download-btn {
            background: linear-gradient(135deg, #A0C49D 0%, #7FB069 100%);
            color: white;
            box-shadow: 0 0 20px rgba(160, 196, 157, 0.3);
        }

        .download-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(160, 196, 157, 0.4);
        }

        .filter-section {
            margin-top: 24px;
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 2px solid #1a73e8;
            font-size: 15px;
            background-color: #f8f9ff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            cursor: pointer;
            color: #4a5568;
            font-weight: 500;
        }

        select:hover, select:focus {
            border-color: #0d6efd;
            box-shadow: 0 2px 5px rgba(26, 115, 232, 0.15);
            outline: none;
            background-color: #e8f0fe;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
            font-style: italic;
            font-size: 16px;
        }

        .file-name {
            margin-top: 12px;
            font-size: 14px;
            color: #5a6268;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 24px;
            }
            .upload-section {
                padding: 20px;
            }
            .chart-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="nav-bar">
        <a href="https://www.aidoc.work" class="nav-brand">
            <span>ğŸ”§</span>
            <span>AiDoc.work</span>
        </a>
        <div class="nav-links">
            <a href="index.html" class="nav-link">ğŸ  é¦–é¡µ</a>
            <a href="æ–‡æœ¬å¤„ç†å·¥å…·.html" class="nav-link">ğŸ”§ æ–‡æœ¬å¤„ç†</a>
            <a href="æ–‡æœ¬å·®å¼‚æ¯”å¯¹.html" class="nav-link">ğŸ” å·®å¼‚æ¯”å¯¹</a>
            <a href="jsä¸²å¤„ç†å·¥å…·.html" class="nav-link">ğŸ“ JSONè§£æ</a>
            <a href="è¡¨æ ¼è½¬åˆ¶.html" class="nav-link">ğŸ“Š è¡¨æ ¼è½¬åˆ¶</a>
            <a href="å›¾ç‰‡è‰²å·æå–.html" class="nav-link">ğŸ¨ è‰²å·æå–</a>
            <a href="æ•°æ®åŒå‘¨æŠ¥å·¥å…·.html" class="nav-link active">ğŸ“ˆ æ•°æ®åŒå‘¨æŠ¥</a>
        </div>
    </nav>

    <div class="container">
        <h1>æ•°æ®åŒå‘¨æŠ¥å·¥å…·</h1>
        
        <div class="upload-section" onclick="document.getElementById('file-input').click()">
            <input type="file" id="file-input" accept=".xlsx, .xls" />
            <button class="upload-btn">
                é€‰æ‹©Excelæ–‡ä»¶
            </button>
            <div class="file-name" id="file-name"></div>
        </div>
        
        <div class="filter-section" id="filter-section" style="display: none;">
            <select id="source-type-filter">
                <option value="all">æ‰€æœ‰åœºæ™¯</option>
            </select>
        </div>
        
        <div id="chart-container" class="chart-container">
            <div class="no-data" id="no-data">è¯·ä¸Šä¼ Excelæ–‡ä»¶ä»¥è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨</div>
        </div>
        
        <div class="controls" id="controls" style="display: none;">
            <button class="control-btn download-btn" id="download-btn">ä¸‹è½½ä¸ºå›¾ç‰‡</button>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let myChart = null;
        let rawData = [];
        let sourceTypes = [];
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            if (myChart !== null) {
                myChart.dispose();
            }
            
            myChart = echarts.init(document.getElementById('chart-container'));
            myChart.showLoading();
        }
        
        // å¤„ç†Excelæ–‡ä»¶ä¸Šä¼ 
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('no-data').style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // å‡è®¾æ•°æ®åœ¨ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSON
                    rawData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (rawData.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼');
                        return;
                    }
                    
                    // æå–æ‰€æœ‰å”¯ä¸€çš„sourceTypeå€¼
                    sourceTypes = [...new Set(rawData.map(item => item.sourceType))];
                    
                    // æ›´æ–°ç­›é€‰ä¸‹æ‹‰æ¡†
                    updateSourceTypeFilter();
                    
                    // æ˜¾ç¤ºç­›é€‰å’Œæ§åˆ¶æŒ‰é’®
                    document.getElementById('filter-section').style.display = 'flex';
                    document.getElementById('controls').style.display = 'flex';
                    
                    // ç”Ÿæˆå›¾è¡¨
                    generateChart('all');
                    
                } catch (error) {
                    console.error('å¤„ç†Excelæ–‡ä»¶æ—¶å‡ºé”™:', error);
                    alert('å¤„ç†Excelæ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        });
        
        // æ›´æ–°åœºæ™¯ç­›é€‰ä¸‹æ‹‰æ¡†
        function updateSourceTypeFilter() {
            const filterSelect = document.getElementById('source-type-filter');
            
            // æ¸…é™¤ç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"æ‰€æœ‰åœºæ™¯"é€‰é¡¹ï¼‰
            while (filterSelect.options.length > 1) {
                filterSelect.remove(1);
            }
            
            // æ·»åŠ æ–°é€‰é¡¹
            sourceTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterSelect.appendChild(option);
            });
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            filterSelect.addEventListener('change', function() {
                generateChart(this.value);
            });
        }
        
        // ç”Ÿæˆå›¾è¡¨
        function generateChart(sourceTypeFilter) {
            initChart();
            
            // ç­›é€‰æ•°æ®
            let filteredData = rawData;
            if (sourceTypeFilter !== 'all') {
                filteredData = rawData.filter(item => item.sourceType === sourceTypeFilter);
            }
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦åŒ…å«hourå­—æ®µ
            let hasHourData = filteredData.some(item => item.hour !== undefined);
            
            // å¦‚æœæ•°æ®ä¸­æ²¡æœ‰hourå­—æ®µä½†æœ‰ç±»ä¼¼"2025/6/9 17:00"æ ¼å¼çš„dayå­—æ®µï¼Œä¹Ÿè§†ä¸ºå°æ—¶çº§åˆ«æ•°æ®
            if (!hasHourData && filteredData.length > 0) {
                const firstItem = filteredData[0];
                if (firstItem.day && typeof firstItem.day === 'string' && firstItem.day.includes(' ')) {
                    // å°†dayå­—æ®µçš„å€¼å¤åˆ¶åˆ°hourå­—æ®µ
                    filteredData.forEach(item => {
                        if (item.day && typeof item.day === 'string' && item.day.includes(' ')) {
                            item.hour = item.day;
                        }
                    });
                    // æ›´æ–°hasHourDataæ ‡å¿—
                    hasHourData = true;
                }
            }
            
            // æŒ‰æ—¥æœŸå’Œå°æ—¶æ’åº
            filteredData.sort((a, b) => {
                if (hasHourData) {
                    // å¦‚æœæœ‰å°æ—¶æ•°æ®ï¼ŒæŒ‰ç…§æ—¥æœŸ+å°æ—¶æ’åº
                    // ç¡®ä¿houræ˜¯å­—ç¬¦ä¸²ç±»å‹å¹¶ä¸”åŒ…å«ç©ºæ ¼
                    const getDatePart = (item) => {
                        if (item.hour) {
                            if (typeof item.hour === 'string' && item.hour.includes(' ')) {
                                return item.hour.split(' ')[0];
                            }
                            return item.hour; // å¦‚æœhourä¸æ˜¯é¢„æœŸçš„æ ¼å¼ï¼Œç›´æ¥è¿”å›
                        }
                        return item.day; // å¦‚æœæ²¡æœ‰hourå­—æ®µï¼Œä½¿ç”¨dayå­—æ®µ
                    };
                    
                    const dateA = new Date(getDatePart(a));
                    const dateB = new Date(getDatePart(b));
                    
                    if (dateA.getTime() === dateB.getTime()) {
                        // å¦‚æœæ—¥æœŸç›¸åŒï¼ŒæŒ‰å°æ—¶æ’åº
                        const getTimePart = (item) => {
                            if (item.hour) {
                                if (typeof item.hour === 'string' && item.hour.includes(' ')) {
                                    return item.hour.split(' ')[1];
                                }
                                return '00:00'; // é»˜è®¤æ—¶é—´
                            }
                            return '00:00';
                        };
                        
                        const hourA = getTimePart(a);
                        const hourB = getTimePart(b);
                        return hourA.localeCompare(hourB);
                    }
                    return dateA - dateB;
                } else {
                    // å¦‚æœæ²¡æœ‰å°æ—¶æ•°æ®ï¼ŒåªæŒ‰æ—¥æœŸæ’åº
                    return new Date(a.day) - new Date(b.day);
                }
            });
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            // ä½¿ç”¨hourå­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨dayå­—æ®µ
            const timePoints = [...new Set(filteredData.map(item => {
                // ç¡®ä¿hourå­—æ®µæ˜¯å¯ç”¨çš„å­—ç¬¦ä¸²æ ¼å¼
                if (item.hour !== undefined) {
                    if (typeof item.hour === 'string') {
                        return item.hour;
                    } else {
                        // å¦‚æœhourä¸æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è½¬æ¢
                        return String(item.hour);
                    }
                }
                return item.day;
            }))];
            
            // è®¡ç®—æ¯ä¸ªæ—¶é—´ç‚¹çš„æ€»è¯·æ±‚é‡å’Œæ‹¦æˆªé‡
            const totalData = [];
            const killData = [];
            const blockRateData = [];
            
            timePoints.forEach(timePoint => {
                 // ç­›é€‰å½“å‰æ—¶é—´ç‚¹çš„æ•°æ®
                 const pointData = hasHourData 
                     ? filteredData.filter(item => {
                         if (item.hour === undefined) return false;
                         
                         // å¤„ç†ä¸åŒç±»å‹çš„hourå­—æ®µ
                         if (typeof item.hour === 'string' && typeof timePoint === 'string') {
                             return item.hour === timePoint;
                         } else {
                             // å°è¯•è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ
                             return String(item.hour) === String(timePoint);
                         }
                     })
                     : filteredData.filter(item => item.day === timePoint);
                 
                 // è®¡ç®—å½“å‰æ—¶é—´ç‚¹çš„æ€»è¯·æ±‚é‡å’Œæ‹¦æˆªé‡
                 const pointTotal = pointData.reduce((sum, item) => sum + (item.total || 0), 0);
                 const pointKill = pointData.reduce((sum, item) => sum + (item.kill || 0), 0);
                 
                 // è®¡ç®—æ‹¦æˆªç‡
                 const blockRate = pointTotal > 0 ? (pointKill / pointTotal * 100).toFixed(2) : 0;
                 
                 totalData.push(pointTotal);
                 killData.push(pointKill);
                 blockRateData.push(blockRate);
             });
            
            // å°†æ—¶é—´ç‚¹æ ¼å¼åŒ–ä¸ºæ˜¾ç¤ºæ ¼å¼
            const formattedTimePoints = timePoints.map(timePoint => {
                // ç¡®ä¿timePointæ˜¯å­—ç¬¦ä¸²
                const timePointStr = String(timePoint);
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå°æ—¶æ ¼å¼ï¼ˆåŒ…å«ç©ºæ ¼ï¼Œå¦‚ "2025/6/9 17:00"ï¼‰
                if (timePointStr.includes(' ')) {
                    // å°è¯•æ ‡å‡†åŒ–æ—¥æœŸæ—¶é—´æ ¼å¼
                    try {
                        const [datePart, timePart] = timePointStr.split(' ');
                        const date = new Date(datePart);
                        if (!isNaN(date.getTime())) {
                            return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${timePart}`;
                        }
                    } catch (e) {}
                    return timePointStr; // å¦‚æœæ— æ³•è§£æï¼Œè¿”å›åŸå§‹å€¼
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ•°å­—ï¼ˆExcelåºåˆ—å·ï¼‰
                const timePointNum = Number(timePointStr);
                if (!isNaN(timePointNum)) {
                    // Excelæ—¥æœŸåºåˆ—å·è½¬æ¢ä¸ºJavaScriptæ—¥æœŸ
                    const excelEpoch = new Date(1899, 11, 30); // Excelçš„èµ·å§‹æ—¥æœŸï¼ˆ1900å¹´1æœˆ0æ—¥ï¼‰
                    const msPerDay = 24 * 60 * 60 * 1000;
                    const jsDate = new Date(excelEpoch.getTime() + timePointNum * msPerDay);
                    
                    // æ ¼å¼åŒ–ä¸ºå¹´/æœˆ/æ—¥
                    return `${jsDate.getFullYear()}/${jsDate.getMonth() + 1}/${jsDate.getDate()}`;
                } else {
                    // å°è¯•è§£æå­—ç¬¦ä¸²æ—¥æœŸ
                    try {
                        const jsDate = new Date(timePointStr);
                        if (!isNaN(jsDate.getTime())) {
                            return `${jsDate.getFullYear()}/${jsDate.getMonth() + 1}/${jsDate.getDate()}`;
                        }
                    } catch (e) {}
                }
                // å¦‚æœæ— æ³•è§£æï¼Œè¿”å›åŸå§‹å€¼
                return timePointStr;
            });
            
            // é…ç½®å›¾è¡¨é€‰é¡¹
            const option = {
                title: {
                    text: hasHourData ? 'è¯·æ±‚é‡ã€æ‹¦æˆªé‡ä¸æ‹¦æˆªç‡å›¾è¡¨ï¼ˆå°æ—¶çº§åˆ«ï¼‰' : 'è¯·æ±‚é‡ã€æ‹¦æˆªé‡ä¸æ‹¦æˆªç‡å›¾è¡¨',
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold',
                        color: '#2c3e50'
                    },
                    padding: [10, 0, 20, 0]
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#e1e4e8',
                    borderWidth: 1,
                    textStyle: {
                        color: '#2c3e50'
                    },
                    axisPointer: {
                        type: 'shadow',
                        shadowStyle: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    formatter: function(params) {
                        // å±•ç¤ºæ ¼å¼åŒ–åçš„æ—¶é—´ç‚¹å­—ç¬¦ä¸²ï¼ˆå¦‚ 6æœˆ25æ—¥ 18:00:00ï¼‰
                        let rawTime = timePoints[params[0].dataIndex];
                        let displayTime = rawTime;
                        let dateObj = null;
                        // åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­—ï¼ˆExcelåºåˆ—å·ï¼‰
                        if (!isNaN(Number(rawTime)) && rawTime !== '' && rawTime !== null && /^\d+(\.\d+)?$/.test(rawTime)) {
                            // Excelåºåˆ—å·è½¬æ—¥æœŸï¼Œç²¾ç¡®åˆ°ç§’
                            const excelEpoch = new Date(Date.UTC(1899, 11, 30)); // UTCï¼Œé¿å…æ—¶åŒºåç§»
                            const days = Math.floor(Number(rawTime));
                            const msPerDay = 24 * 60 * 60 * 1000;
                            let ms = days * msPerDay;
                            // å°æ•°éƒ¨åˆ†è½¬ä¸ºå½“å¤©çš„æ—¶é—´
                            const fraction = Number(rawTime) - days;
                            ms += Math.round(fraction * msPerDay);
                            dateObj = new Date(excelEpoch.getTime() + ms);
                        } else if (typeof rawTime === 'string') {
                            // å°è¯•è§£æå¸¸è§æ—¥æœŸå­—ç¬¦ä¸²
                            // æ”¯æŒ"2024/6/25 18:00"æˆ–"2024-06-25 18:00:00"
                            let replaced = rawTime.replace(/-/g, '/');
                            dateObj = new Date(replaced);
                        }
                        if (dateObj && !isNaN(dateObj.getTime())) {
                            // æ ¼å¼åŒ–ä¸º"6æœˆ25æ—¥ 18:00:00"
                            let M = dateObj.getMonth() + 1;
                            let D = dateObj.getDate();
                            let h = dateObj.getHours().toString().padStart(2, '0');
                            let m = dateObj.getMinutes().toString().padStart(2, '0');
                            let s = dateObj.getSeconds().toString().padStart(2, '0');
                            displayTime = `${M}æœˆ${D}æ—¥ ${h}:${m}:${s}`;
                        }
                        let result = `<div style=\"font-weight:bold;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #e1e4e8;font-size:14px;color:#2c3e50;\">${displayTime}</div>`;
                        // è¯·æ±‚é‡
                        const totalParam = params.find(p => p.seriesName === 'è¯·æ±‚é‡');
                        if (totalParam) {
                            result += `<div style=\"margin:4px 0;\">${totalParam.marker} <span style=\"font-weight:500;display:inline-block;width:60px;\">${totalParam.seriesName}:</span> <span style=\"font-weight:bold;color:#5470C6;\">${totalParam.value.toLocaleString()}</span></div>`;
                        }
                        // æ‹¦æˆªé‡
                        const killParam = params.find(p => p.seriesName === 'æ‹¦æˆªé‡');
                        if (killParam) {
                            result += `<div style=\"margin:4px 0;\">${killParam.marker} <span style=\"font-weight:500;display:inline-block;width:60px;\">${killParam.seriesName}:</span> <span style=\"font-weight:bold;color:#91CC75;\">${killParam.value.toLocaleString()}</span></div>`;
                        }
                        // æ‹¦æˆªç‡
                        const blockRateParam = params.find(p => p.seriesName === 'æ‹¦æˆªç‡');
                        if (blockRateParam) {
                            result += `<div style=\"margin:4px 0;\">${blockRateParam.marker} <span style=\"font-weight:500;display:inline-block;width:60px;\">${blockRateParam.seriesName}:</span> <span style=\"font-weight:bold;color:#EE6666;\">${blockRateParam.value}%</span></div>`;
                        }
                        // å¦‚æœæœ‰sourceTypeä¿¡æ¯ï¼Œä¹Ÿæ˜¾ç¤ºåœ¨tooltipä¸­
                        if (params[0].data && params[0].data.sourceType) {
                            result += `<div style=\"margin-top:6px;padding-top:6px;border-top:1px solid #e1e4e8;font-size:12px;color:#666;\">åœºæ™¯: ${params[0].data.sourceType}</div>`;
                        }
                        return result;
                    }
                },
                legend: {
                    data: ['è¯·æ±‚é‡', 'æ‹¦æˆªé‡', 'æ‹¦æˆªç‡'],
                    bottom: 10,
                    icon: 'roundRect',
                    itemWidth: 12,
                    itemHeight: 12,
                    textStyle: {
                        color: '#2c3e50'
                    },
                    itemGap: 20
                },
                grid: {
                    left: '3%',
                    right: '5%',
                    bottom: '15%',
                    top: '10%',
                    containLabel: true,
                    width: 'auto' // è‡ªåŠ¨è°ƒæ•´å®½åº¦ä»¥é€‚åº”å®¹å™¨
                },
                xAxis: {
                    type: 'category',
                    data: formattedTimePoints,
                    axisLine: {
                        lineStyle: {
                            color: '#cfd7df'
                        }
                    },
                    axisTick: {
                        alignWithLabel: true,
                        lineStyle: {
                            color: '#cfd7df'
                        }
                    },
                    axisLabel: {
                        rotate: 45,
                        margin: 15,
                        color: '#5a6268',
                        fontSize: 12,
                        interval: 'auto', // è‡ªåŠ¨è®¡ç®—é—´éš”ï¼Œé¿å…æ ‡ç­¾é‡å 
                        hideOverlap: true, // éšè—é‡å çš„æ ‡ç­¾
                        formatter: function(value) {
                            // æ£€æŸ¥æ˜¯å¦ä¸ºå°æ—¶æ ¼å¼ï¼ˆåŒ…å«ç©ºæ ¼ï¼Œå¦‚ "2025/6/9 17:00"ï¼‰
                            if (typeof value === 'string' && value.includes(' ')) {
                                // åˆ†ç¦»æ—¥æœŸå’Œæ—¶é—´éƒ¨åˆ†
                                const [datePart, timePart] = value.split(' ');
                                // å°è¯•è§£ææ—¥æœŸéƒ¨åˆ†
                                try {
                                    const date = new Date(datePart);
                                    if (!isNaN(date.getTime())) {
                                        // è¿”å›æ ¼å¼åŒ–çš„æ—¥æœŸå’Œæ—¶é—´
                                        return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${timePart}`;
                                    }
                                } catch (e) {}
                                return value;
                            }
                            
                            // å¤„ç†ä»…æœ‰æ—¥æœŸçš„æƒ…å†µ
                            try {
                                const date = new Date(value);
                                if (!isNaN(date.getTime())) {
                                    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                                }
                            } catch (e) {}
                            return value;
                        }
                    },
                    splitLine: {
                        show: false
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'æ•°é‡',
                        position: 'left',
                        nameTextStyle: {
                            color: '#5470C6',
                            fontSize: 13,
                            padding: [0, 0, 0, -30]
                        },
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#5470C6'
                            }
                        },
                        axisLabel: {
                            formatter: '{value}',
                            color: '#5a6268'
                        },
                        splitLine: {
                            lineStyle: {
                                color: '#eaecef',
                                type: 'dashed'
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'æ‹¦æˆªç‡(%)',
                        position: 'right',
                        nameTextStyle: {
                            color: '#E67E22',
                            fontSize: 13,
                            padding: [0, -30, 0, 0]
                        },
                        min: 0,
                        max: function(value) {
                            // æ ¹æ®å®é™…æ•°æ®åŠ¨æ€è®¾ç½®æœ€å¤§å€¼
                            // æ‰¾å‡ºæœ€å¤§æ‹¦æˆªç‡å€¼ï¼Œå¹¶å‘ä¸Šå–æ•´åˆ°æœ€æ¥è¿‘çš„æ•´æ•°
                            const maxRate = Math.max(...blockRateData.map(item => parseFloat(item.value || item)));
                            return Math.ceil(maxRate) + 0.5;
                        },
                        interval: function(value) {
                            // æ ¹æ®æœ€å¤§å€¼åŠ¨æ€è®¾ç½®é—´éš”
                            return value.max / 5;
                        },
                        axisLine: {
                            show: true,
                            lineStyle: {
                                color: '#E67E22'
                            }
                        },
                        axisLabel: {
                            formatter: '{value}%',
                            color: '#5a6268'
                        },
                        splitLine: {
                            show: false
                        }
                    }
                ],
                series: [
                    {
                        name: 'è¯·æ±‚é‡',
                        type: 'bar',
                        data: totalData,
                        yAxisIndex: 0,
                        barMaxWidth: 40,
                        itemStyle: {
                            color: '#5470C6',
                            borderRadius: [4, 4, 0, 0]
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        z: 10
                    },
                    {
                        name: 'æ‹¦æˆªé‡',
                        type: 'bar',
                        data: killData,
                        yAxisIndex: 0,
                        barMaxWidth: 40,
                        itemStyle: {
                            color: '#EE6666',
                            borderRadius: [4, 4, 0, 0]
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        z: 10
                    },
                    {
                        name: 'æ‹¦æˆªç‡',
                        type: 'line',
                        data: blockRateData,
                        yAxisIndex: 1,
                        symbol: 'circle',
                        symbolSize: 8,
                        itemStyle: {
                            color: '#E67E22',
                            borderWidth: 2
                        },
                        lineStyle: {
                            width: 3,
                            shadowColor: 'rgba(230, 126, 34, 0.3)',
                            shadowBlur: 10,
                            type: 'solid'
                        },
                        smooth: true,
                        emphasis: {
                            focus: 'series',
                            itemStyle: {
                                borderWidth: 3
                            }
                        },
                        z: 11
                    }
                ]
            };
            
            myChart.hideLoading();
            myChart.setOption(option);
            
            // å“åº”çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }
        
        // ä¸‹è½½å›¾è¡¨ä¸ºå›¾ç‰‡
        document.getElementById('download-btn').addEventListener('click', function() {
            if (!myChart) {
                alert('è¯·å…ˆç”Ÿæˆå›¾è¡¨ï¼');
                return;
            }
            
            // æ·»åŠ æ°´å°å’Œæ—¶é—´æˆ³
            const timestamp = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const url = myChart.getDataURL({
                type: 'png',
                pixelRatio: 2,
                backgroundColor: '#fff',
                excludeComponents: ['toolbox']
            });
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦åŒ…å«å°æ—¶ä¿¡æ¯
            const hasHourData = rawData.some(item => item.hour !== undefined);
            const filePrefix = hasHourData ? 'å°æ—¶çº§æ•°æ®æŠ˜çº¿å›¾_' : 'æ•°æ®æŠ˜çº¿å›¾_';
            
            const link = document.createElement('a');
            link.download = filePrefix + new Date().toISOString().slice(0, 10) + '.png';
            link.href = url;
            link.click();
            
            // æ˜¾ç¤ºä¸‹è½½æˆåŠŸæç¤º
            const successMsg = document.createElement('div');
            successMsg.style.position = 'fixed';
            successMsg.style.bottom = '20px';
            successMsg.style.left = '50%';
            successMsg.style.transform = 'translateX(-50%)';
            successMsg.style.backgroundColor = 'rgba(39, 174, 96, 0.9)';
            successMsg.style.color = 'white';
            successMsg.style.padding = '10px 20px';
            successMsg.style.borderRadius = '4px';
            successMsg.style.zIndex = '9999';
            successMsg.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
            successMsg.textContent = 'å›¾ç‰‡å·²æˆåŠŸä¸‹è½½ï¼';
            
            document.body.appendChild(successMsg);
            
            setTimeout(function() {
                successMsg.style.opacity = '0';
                successMsg.style.transition = 'opacity 0.5s ease';
                setTimeout(function() {
                    document.body.removeChild(successMsg);
                }, 500);
            }, 2000);
        });
    </script>
</body>
</html>